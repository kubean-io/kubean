on: workflow_call

env:
  QINIU_SHELL_TAR: qshell-v2.8.0-linux-amd64.tar.gz

jobs:
  upload-qiniu:
    runs-on: self-hosted
    permissions:
      packages: write
      contents: read
    steps:
      - name: Restore offline-build cache
        uses: actions/cache@v3
        with:
          path: ${{ github.ref_name }}/
          key: offline-build

      - name: Restore os-pkgs-build cache
        uses: actions/cache@v3
        with:
          path: |
            kubean-*.sha256sum.txt
            kubean-*-amd64.tar.gz
            kubean-*-arm64.tar.gz
          key: os-pkgs-build

      - name: Upload tar file to qiniu
        run: |
          ls -lh ${{ github.ref_name }}/
          mv kubean-*.sha256sum.txt ${{ github.ref_name }}/os-pkgs/
          mv kubean-*-amd64.tar.gz ${{ github.ref_name }}/os-pkgs/
          mv kubean-*-arm64.tar.gz ${{ github.ref_name }}/os-pkgs/
          tar -zcvf kubean-${{ github.ref_name }}.tar.gz ${{ github.ref_name }}/
          wget https://devtools.qiniu.com/$QINIU_SHELL_TAR
          tar -zxvf $QINIU_SHELL_TAR
          mv qshell /usr/local/bin/
          qshell account -w ${{ secrets.QINIU_AK }} ${{ secrets.QINIU_SK }} 'dce-ci'
          echo 'delete the same name of old file'
          qshell delete ${{ secrets.QINIU_BU }} DaoCloud_Enterprise/dce5/kubean-${{ github.ref_name }}.tar.gz
          echo 'upload to qiniu'
          qshell rput ${{ secrets.QINIU_BU }} DaoCloud_Enterprise/dce5/kubean-${{ github.ref_name }}.tar.gz kubean-${{ github.ref_name }}.tar.gz

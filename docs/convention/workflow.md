# 应用工作台workflow（v0.2）

```
Author: Xiao.Yang <yang.xiao@daocloud.io>
Date: 2022-5-8
```

## Scrum Overview

1. 计划会： ~4hr（每小时休息10分钟）
    1. 准备工作：
        1. 产品backlog和产品负责人（产品负责人必修参加会议）
        2. 所有重要的backlog条目都已经根据重要性被评过分（0~150 相对分数，重要性低的具体分数无所谓，反正也不会在该sprint被分配）
        3. 产品负责人应当理解每个故事的含义
    2. 成果：
        1. **sprint目标**
        2. 团队成员名单（以及他们的投入程度，如果不是 100%的话。）
        3. **sprint backlog**(即sprint中包括的故事列表)
        4. 确定好sprint演示日期
        5. 确定好时间地点，供举行每日scrum会议
    3. 流程（以13:00 – 17:00 为例）
        1. 13:00 – 13:30。产品负责人对 sprint 目标进行总体介绍，概括产品 backlog。定下演示的时间地点。
        2. 13:30 – 15:00。团队估算时间，在必要的情况下拆分 backlog 条目。产品负责人在必要时修改重要性评分。理清每个条目的含义。所有重要性高的 backlog 条目都要填写“如何演示”。
        3. 15:00 – 16:00。团队选择要放入 sprint 中的故事。计算生产率，用作核查工作安排的基础。
        4. 16:00 – 17:00。为每日 scrum 会议(以下简称每日例会)安 排固定的时间地点(如果和上次不同的话)。把故事进一步拆分成任务。
    4. 会后：SM更新信息页
2. 每日站会 ~15min
    1. 更新任务板：包括移动，更新时间估算和新增（当讲的是未经计划的条目时）
3. PBR: 任务成果demo ~1hr
4. 回顾会：时间 1 ~ 3hr，潜在主题：“我们怎样才能在下个sprint中做的更好”
    1. SM展示sprint backlog，在团队帮助下做sprint总结，包括重要事件和决策等；
    2. 轮流发言，不被打断的情况下说出，**什么是好的，哪些可以做得更好，哪些需要改变**；
    3. 对预估生产率和实际生产率进行比较；
    4. SM具体建议进行总结，得出下个sprint需要改进的地方，一般不超过5个。

## PBR Checklist

- 确保清晰阐述了 sprint 目标。如果在演示上有些人对产品一无所知，那就花上几分钟来进行描述。
- 不要花太多时间准备演示，尤其是不要做花里胡哨的演讲。把那些玩意儿扔一边去，集中精力演示可以实际工作的代码。
- 节奏要快，也就是说要把准备的精力放在保持演示的快节奏上，而不是让它看上去好看。
- 让演示关注于业务层次，不要管技术细节。注意力放在“我们做了什么”，而不是“我们怎么做的”。
- 可能的话，让观众自己试一下产品。
- 不要演示一大堆细碎的 bug 修复和微不足道的特性。你可以提到一些，但是不要演示，因为它们通常会花很长时间， 而且会分散大家的注意力，让他们不能关注更加重要的故事。

## Scrum Master Checklist

### sprint 开始阶段

- Sprint计划会议之后，创建Sprint信息页面。
  - ~~在 wiki 上创建从 dashboard 指向所创建页面的链接。~~
  - ~~把页面打印出来，贴在通过你们团队工作区域之外的墙上，让经过的人都可以看到。~~
  - 更新企业微信上Scrum团队的群公告
- ~~给每个人发邮件，声明新的 sprint 已经启动。邮件中要包括 sprint 目标和指向 sprint 信息页面的链接。~~
- 更新sprint数据文档。加入估算生产率、团队大小和sprint长度等等。

### 每一天

- 确保每日Scrum会议可以按时开始和结束。
- 为了保证sprint可以如期完成，需要适当地增删故事。
  - 确保产品负责人了解这些变化。
- 确保团队可以及时得知 Sprint backlog 和燃尽图的最新状况。
- 确保存在的问题和障碍都能被解决，并报告给产品负责人以及(或者)开发主管。

### 在 sprint 结束时

- 进行开放式的 Sprint 演示。
- 在演示开始前一两天，就要通知到每个人。
- 与整个团队以及产品负责人一起开 Sprint 回顾会议。开发主管也应该受邀参加，他可以把你们的经验教训大范围传播开来。
- 更新 **sprint 数据文档**。加入实际生产率和回顾会议中总结出的关键点。

## Spint 信息页模板

```
**Sprint 目标**
- Beta-ready release!

**Sprint backlog(估算时间)**
- Deposit (3)
- Migration tool (8)
- Backoffice login (5)
- Backoffice user admin (5)
预估生产率：21

**安排**
- Sprint周期：2006-11-06 ~ 2006-11-24
- 每日例会：9:30-9:45，团队办公室
- Sprint demo: 2006-11-24，13:00，在XX会议室

团队成员
- Jim
- Erica (scrum master)
- Tom (75%)
- Eva

```

## 工具

### Overview

所有任务统一通过gitlab issues的方式记录，通过标签分类和管理。

### 产品Backlog

产品 backlog 是 Scrum 的核心，也是一切的起源。从根本上说，它就是一个需求、或故事、或特性等组成的列表，按照重要性的级别进行了排序。它里面包含的是客户想要的东西，**并用客户的术语加以描述**。

<details>
<summary>一个“故事”包含的字段</summary>
<pre><code>
- ID——统一标识符，就是个自增长的数字而已。以防重命名故事以后找不到它们。
- Name(名称)——简短的、描述性的故事名。比如“查看你自己的交易明细”。它必须要含义明确，这样开发人员 和产品负责人才能大致明白我们说的是什么东西，跟其他 故事区分开。它一般由 2 到 10 个字组成。
- Importance(重要性)——产品负责人评出一个数值，指示这个故事有多重要。例如 10 或 150。分数越高越重要。
    - 我一直都想避免“优先级”这个说法，因为一般说 来优先级 1 都表示“最高”优先级，如果后来有其 他更重要的东西就麻烦了。它的优先级评级应该是什么呢?优先级 0?优先级-1?
- Initial estimate(初始估算)——团队的初步估算，表示与其他故事相比，完成该故事所需的工作量。最小的单位是故事点(story point)，一般大致相当于一个“理想的人天 (man-day)”。
    - 问一下你的团队，“如果可以投入最适合的人员来 完成这个故事(人数要适中，通常为 2 个)，把你 们锁到一个屋子里，有很多食物，在完全没有打扰 的情况下工作，那么需要几天，才能给出一个经过 测试验证，可以交付的完整实现呢?”如果答案是 “把3个人关在一起，大约需要 4 天时间”，那么 初始估算的结果就是 12 个故事点。
    - 不需要保证这个估值绝对无误(比如两个故事点的 故事就应该花两天时间)，而是要保证相对的正确 性(即，两个点的故事所花费的时间应该是四个点 的故事所需的一半)
- How to demo(如何做演示)——它大略描述了这个故事应 该如何在 sprint 演示上进行示范，本质就是一个简单的测 试规范。“先这样做，然后那样做，就应该得到......的结果”。
    - 如果你在使用 TDD(测试驱动开发)，那么这段 描述就可以作为验收测试的伪码表示。
- Notes(注解)——相关信息、解释说明和对其它资料的引 用等等。一般都非常简短。
</code></pre>
</details>


产品负责人通过wiki上的表格来维护产品Backlog。格式如下：

| ID | 名称 | 重要性 | 预估 | 如何demo | Notes |
|:--|:--|:--|:--|:--|:--|
| 1 | 存款 | 30 | 5 | 登录，打开存款界面，存入10欧元，转到我的账户余额界面，检查我的余额增加了10欧元 | 需要UML顺序图。目前不需要考虑加密的问题 |
| 2 | 查看自己的交易明细 | 10 | 8 | 登录，点击“交易”，存入一笔款项。返回交易页面，看到新的存款显示在页面上。 | 使用分页技术避免大规模的数据库查询。和查看 用户列表的设计相似。 |

#### 技术故事

技术故事又可以被称为非功能性条目，指的是那些需要完成但又不属于可交付物的东西，跟任何故事都没有 直接关联，不会给产品负责人带来直接的价值。例如：

- 安装持续构建服务器
- 编写系统设计概览
- 重构 DAO 层
- 升级 Jira

这种故事不属于产品Backlog，一般需要一些特殊的处理，例如：

1. 试着避免技术故事。努力找到一种方式，把技术故事变成可以衡量业务价值的普通故事。这样有助于产品负责人做出正确的权衡。
2. 如果无法把技术故事转变成普通故事，那就看看这项工作能不能当作另一个故事中的某个任务。例如，“重构 DAO 层”可以作为“编辑用户”中的一个任务，因为这个故事 会涉及到 DAO 层。
3. 如果以上二者都不管用，那就把它定义为一个技术故事， 用另外一个单独的列表来存放。产品负责人能看到它，但是不能编辑它。用“投入程度”和“预估生产率”这两个参数来跟产品负责人协商，从 sprint 里拨出一些时间来完 成这些技术故事。

### Sprint Backlog

sprint backlog是当前sprint需要完成的故事，团队在计划会上根据重要性和生成率决定挑选哪些故事从产品Backlog中放到Sprint Backlog里。

在计划会上确定了时间和目标后需要创建milestone。

Sprint Backlog通过gitlab issues管理，在计划会前创建issue并打上标签 `kind/story` （表示这是一个故事），如果讨论决定要这个sprint完成则打上标签 `status/backlog`，并且关联上milestone。

> 产品Backlog从Excel到gitlab的同步可以通过小工具自动完成。

### 任务

计划会需要把故事进一步拆分成具体可执行的任务。这些任务也是通过gitlab issues来管理。

以故事”存款“为例，可以拆分的任务包括：

- 测试用例编写
- 编写failing test
- API和表设计
- DAO
- 后端服务开发
- UI开发
- 集成测试
- 代码清理
- 产品文档补充

每个拆分出来的任务应该包含以下字段，并且和故事关联起来（通过`Linked issues`）：

- 类型，用来对任务进行管理，包括：
  - kind/design：设计，产品设计、模块设计、API设计、表设计、GUI设计、接口设计等；
  - kind/impl：构建动作相关，包括功能开发、UT编写、e2e测试编写;
  - kind/documentation：文档；
  - kind/cleanup: 代码、文档清理；
  - kind/infra：基础设施型工作，例如CICD、测试环境搭建、编写测试辅助脚本或工具；
  - kind/others：未在以上列出，可以后续添加
- 状态，用来在Scrum面板进行管理，包含：
  - status/backlog：在当前sprint中但是还没有开始；
  - status/ongoing: working in progress；
  - status/done: 完成，注意不能直接close；
- 预计耗时估计，可通过 `/estimate <1w 2d 3h 4m>` 指令预估任务耗时，最小单位为0.5d；

sprint临时添加的任务需要加上标签 `unplanned`，可以不和某个故事关联上。

#### 质量控制：测试、验收和Bug管理

- 测试：测试人员也在scrum团队中，跟着sprint走，通过编写UT、集成测试和e2e测试保证质量，也通过冒烟测试对功能进行验证，如果测试成为瓶颈，也可以把团队中所有人分配给测试先生当助手。测试通过也标志这个story完成；
- 验收：当sprint结束会发版，有的软件需要和其他系统集成，在部署到生产环境或交付给客户之前，需要有专门的团队进行验收测试，这个过程不跟着sprint走（可以在下个sprint完成，也可以过很长时间才完成）；
- bug管理：
  - 所有在gitlab中报告的bug的issue都要打上`kind/bug`标签，并且关联上对应的story；
  - 测试过程中发现的bug可以通过gitlab issues也可以通过口头的方式向开发说明，并且必须在当前sprint被修复，无法被修复的当做故事未完成，不能关闭issue和合入PR（已经合入的需要被revert）；
  - 验收过程中发现的bug，必须以正规的形式提到gitlab issues中，对于重要且紧急的bug需要修复并且发布新的PATCH版本，比如1.2.0 -> 1.2.1（可能会影响当前sprint的故事！）；对于不紧急的由产品负责人在后续的计划会中和产品backlog一起提出后（可以将1个或多个bug转换成一个故事，也可以直接列出那些优先级高的bug），进行安排和修复；

### 任务板

我们使用gitlab boards作为我们的任务板。每日例会时需要对着gitlab boards进行说明，并对任务进行移动、更新时间估算和新增；

我们使用企业微信文档的表格来绘制燃尽图，每日例会结束前SM更新表格以重绘燃尽图。

我们使用wiki来创建和归档Sprint信息页面和记录Sprint数据。

## git workflow

我们的git workflow主要参考gitlab flow，[这篇文章](https://www.ruanyifeng.com/blog/2015/12/git-workflow.html)有较为详细的说明，我们不再赘述。简单来说:

- `main` 分支是我们唯一的上游分支，所有开发分支都基于该分支拉出，通过Merge Request合入，main分支的代码会被集成和部署到我们的测试环境；
- sprint结束，发布稳定版本的时候会创建tag并从main分支拉出一个例如`2-3-stable`，以后只有修补bug，才允许将代码合并到这些分支，并且此时要更新小版本号。新发布的版本会部署到demo-alpha环境；

### 分支命名风格

- 所有的分支都基于main分支创建；
- 分支名应该足够简短且具有代表性，包含1~4个单词，使用中横线分割，表示本次修改主要做什么（可以省略动词）。例如：empty-nil-blank、rm-default-type-submit、rebuild-model-properties；
- 如果该分支的创建是为了增加新功能，加上 feature/ 前缀； 其他的情况使用包括bugfix/、docs/、enhancement/、others/ 的前缀
- 如果该分支的创建是为了修复临时的紧急的bug，加上hotfix/*前缀，并将修改结果应用到对应的稳定发布分支中（通过[cherry-pick](https://backlog.com/git-tutorial/cn/stepup/stepup7_4.html)）；

### Merge Request合入流程

- MR的标题以简短概括的中文书写，还未就绪的需要在标题前加上`WIP:`或`Draft:`；
- MR需要按照相应的模板进行明确的书写和说明，例如feature，需要说明实现思路并附上测试结果，并关联上相关issue；
- 提交的MR会依次经过静态代码检查、单元测试、构建和E2E测试；
- 此外，需要2个相关的开发人员进行code review后，在评论中打上`/lgtm`后方可合入；
- 如果一个 MR 包含多个commits，需要勾选`Squash commits`压缩成一个commit合入；
- 合入到main分支后的代码会部署到测试环境；

## 应用工作台信息汇总

- Scrum面板：<https://gitlab.daocloud.cn/ndx/kubean/-/boards>
- 每日任务白板：<https://dwiki.daocloud.io/pages/viewpage.action?pageId=118577453>
- 每日站会地址：<https://meeting.tencent.com/dm/tLtuNlzakzLc> 625-1764-9578
- Scrum信息页和数据记录：<https://dwiki.daocloud.io/pages/viewpage.action?pageId=121147823>
- 信息架构：<https://dwiki.daocloud.io/pages/viewpage.action?pageId=118576479>
- 线框图&功能模块：<https://modao.cc/app/G4oVJ61gravk2q89A2gECQ>
- 相关环境和资源：<https://dwiki.daocloud.io/pages/viewpage.action?pageId=121148008>

## 其他

这篇规范主要借鉴了[《硝烟中的Scrum和XP：我们如何实施Scrum》](http://infoq.com/cn/minibooks/scrum-xp-from-the-trenches)一书中提供的宝贵经验，作为我们团队实施Scrum的重要指导，这篇100多页的小书非常清晰地介绍了如何将Scrum里面的概念融合进项目开发的实践中，以及这些概念背后的意义（比如说：为什么需要燃尽图这种看起来花里胡哨的东西？如何更准确地评估故事点，评估得不准是否还有继续执行的必要？为什么验收测试不在sprint里？等等），任何有半天时间空余的人都应该至少读一遍。

default:
  image: release-ci.daocloud.io/common-ci/common-ci-builder:v0.1.15
  tags:
    - k8s
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - scheduler_failure
  before_script:
    - echo "before_script"
    - git version
    - go version
    - go env -w GO111MODULE=on
    - go env -w GOPROXY="http://10.6.229.27"

# add 'node_modules' to cache for speeding up builds

variables:
  GET_SOURCES_ATTEMPTS: 3

stages:
  # - build
  - security-scanning

# build_to_release_ci:
#   retry:
#     max: 2
#   tags:
#     - docker
#   before_script:
#     - docker -v #override the global before_script
#   stage: build
#   script:
#     - export REGISTRY_USER_NAME=$CI_REGISTRY_USER_NAME
#     - export REGISTRY_PASSWORD=$CI_REGISTRY_PASSWORD
#     - export REGISTRY_REPO="release-ci.daocloud.io/kubean"
#     - export REGISTRY_SERVER_ADDRESS="release-ci.daocloud.io"
#     - export HELM_REPO="https://release-ci.daocloud.io/chartrepo/kubean"
#     - make -j2 release
#   interruptible: true

security-scanning:
  retry:
    max: 2
  tags:
    - docker
  before_script:
  stage: security-scanning
  script:
    - export REGISTRY_REPO="release-ci.daocloud.io/kubean"
    - make security-scanning
  interruptible: true
